è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„æƒ³æ³•ã€‚**â€œæ¨¡å‹æ•ˆæœå¥½â€ä¸åº”è¯¥åªæ˜¯ä¸€ä¸ªå†·å†°å†°çš„ AUC æ•°å­—**ï¼Œé¢†å¯¼éœ€è¦çš„æ˜¯**â€œä½“æ„Ÿâ€**å’Œ**â€œè§£é‡Šæ€§â€**ã€‚

ä½ éœ€è¦æ„å»ºä¸€å¥—**â€œæ¨¡å‹è¿›åŒ–æ—¥æŠ¥ (Model Evolution Report)â€**ç³»ç»Ÿã€‚è¿™å¥—ç³»ç»Ÿä¸åªæ˜¯æŠ¥å–œï¼Œè¿˜è¦è®²æ•…äº‹ï¼šå‘Šè¯‰é¢†å¯¼æ¨¡å‹**â€œå­¦åˆ°äº†ä»€ä¹ˆæ–°çŸ¥è¯†â€**ä»¥åŠ**â€œä¿®æ­£äº†ä»€ä¹ˆæ—§é”™è¯¯â€**ã€‚

æˆ‘å»ºè®®ä» **å®è§‚ï¼ˆæŒ‡æ ‡ï¼‰ã€ä¸­è§‚ï¼ˆå› å­/çŸ¥è¯†ï¼‰ã€å¾®è§‚ï¼ˆå…·ä½“æ¡ˆä¾‹ï¼‰** ä¸‰ä¸ªç»´åº¦æ¥è®¾è®¡è¿™å¥—è½åœ°æ–¹æ¡ˆã€‚

---

### æ–¹æ¡ˆè®¾è®¡æ€»è§ˆï¼šæ¯æ—¥æ¨¡å‹è¿›åŒ–æ—¥æŠ¥

#### 1. å®è§‚ç»´åº¦ï¼šæ ¸å¿ƒæŒ‡æ ‡çœ‹æ¿ (The Scoreboard)
**ç›®çš„**ï¼šä¸€ç§’é’Ÿçœ‹æ‡‚â€œä»Šå¤©æ¯”æ˜¨å¤©å¼ºâ€ã€‚
*   **åŸºç¡€æŒ‡æ ‡**ï¼šAUCã€LogLoss çš„æ¶¨è·Œå¹…ï¼ˆç”¨çº¢/ç»¿ç®­å¤´å±•ç¤ºï¼‰ã€‚
*   **ä¸šåŠ¡æ¨¡æ‹ŸæŒ‡æ ‡ (Top-K Hit Rate)**ï¼š
    *   *è¯æœ¯*ï¼šâ€œåœ¨ä»Šå¤©çš„éªŒè¯é›†ä¸Šï¼Œæ–°æ¨¡å‹æŠŠå®¢æˆ·æœ€ç»ˆå»çš„é—¨åº—æ’åœ¨**å‰ 3 å**çš„æ¯”ä¾‹ï¼Œæ¯”æ—§æ¨¡å‹æå‡äº† **2.5%**ã€‚â€
    *   è¿™æ˜¯é¢†å¯¼æœ€èƒ½å¬æ‡‚çš„ä¸šåŠ¡è¯­è¨€ã€‚

#### 2. ä¸­è§‚ç»´åº¦ï¼šçŸ¥è¯†å‘ç°ä¸å› å­å˜åŠ¨ (Knowledge Discovery)
**ç›®çš„**ï¼šå±•ç¤ºæ¨¡å‹å­¦åˆ°äº†ä»€ä¹ˆâ€œæ–°è¶‹åŠ¿â€ã€‚
*   **Embeddig å‰§å˜æ¦œ**ï¼š
    *   è®¡ç®—æ¯ä¸ªå“ç‰Œ/ç½‘ç‚¹ ID åœ¨æ–°æ—§æ¨¡å‹ä¸­ Embedding å‘é‡çš„å·®å¼‚ï¼ˆL2 è·ç¦»ï¼‰ã€‚
    *   *è¯æœ¯*ï¼šâ€œæ¨¡å‹ä»Šå¤©é‡ç‚¹è°ƒæ•´äº†å¯¹ **â€˜å°ç±³æ±½è½¦â€™** å’Œ **â€˜ç½‘ç‚¹Aâ€™** çš„è®¤çŸ¥ã€‚â€
*   **ç‰¹å¾é‡è¦æ€§åç§» (SHAP)**ï¼š
    *   *è¯æœ¯*ï¼šâ€œä»Šå¤©ï¼Œ**â€˜å¯¼èˆªè·ç¦»â€™** çš„æƒé‡ä¸‹é™äº†ï¼Œè€Œ **â€˜ç½‘ç‚¹æ“…é•¿å“ç‰Œâ€™** çš„æƒé‡ä¸Šå‡äº†ï¼ˆè¯´æ˜ä¸‹é›¨å¤©å¤§å®¶æ›´åœ¨æ„èƒ½ä¸èƒ½ä¿®å¥½ï¼Œè€Œä¸æ˜¯è·ç¦»ï¼‰ã€‚â€

#### 3. å¾®è§‚ç»´åº¦ï¼šBad Case ä¿®å¤å±•ç¤º (The "Save" Cases)
**ç›®çš„**ï¼šç”¨å…·ä½“æ¡ˆä¾‹äº§ç”Ÿå†²å‡»åŠ›ã€‚
*   **ç­›é€‰é€»è¾‘**ï¼šæ‰¾åˆ°é‚£äº› **æ—§æ¨¡å‹é¢„æµ‹æ’åœ¨ç¬¬ 10 åå¼€å¤–**ï¼Œä½† **æ–°æ¨¡å‹æˆåŠŸæ’è¿›å‰ 3 å** çš„çœŸå®æˆäº¤æ¡ˆä¾‹ã€‚
*   *è¯æœ¯*ï¼šâ€œ**æ¡ˆä¾‹å›æ”¾**ï¼šå®¢æˆ·å¼€ä¿æ—¶æ·ï¼Œæ—§æ¨¡å‹æ¨èäº†é™„è¿‘çš„æ™®é€šä¿®ç†å‚ï¼ˆé”™ï¼‰ï¼›æ–°æ¨¡å‹æ¨èäº†ç¨è¿œçš„å¾·ç³»ä¸“ä¿®åº—ï¼ˆå¯¹ï¼‰ã€‚å› ä¸ºæ–°æ¨¡å‹å­¦åˆ°äº†â€˜ä¿æ—¶æ·â€™å¯¹â€˜èµ„è´¨â€™çš„é«˜æ•æ„Ÿåº¦ã€‚â€

---

### æŠ€æœ¯è½åœ°å®ç° (Python ä»£ç æ¡†æ¶)

ä½ éœ€è¦ç¼–å†™ä¸€ä¸ª `ModelComparator` ç±»ï¼Œåœ¨æ¯æ—¥å¢é‡è®­ç»ƒç»“æŸåè¿è¡Œï¼Œå¹¶ç”Ÿæˆä¸€ä»½ HTML æˆ– Markdown æŠ¥å‘Šã€‚

#### æ­¥éª¤ 1: å®šä¹‰æ¯”è¾ƒå™¨ä¸ Embedding å˜åŠ¨è®¡ç®—

```python
import torch
import numpy as np
import pandas as pd
from scipy.spatial.distance import euclidean

class ModelInsightGenerator:
    def __init__(self, old_model, new_model, vocab_mapper, config):
        self.old_model = old_model
        self.new_model = new_model
        self.vocab = vocab_mapper # ä¹‹å‰å®šä¹‰çš„ PersistentVocabMapper
        self.config = config
        
    def get_embedding_shifts(self, feature_name='brand_name', top_k=5):
        """
        [ä¸­è§‚ç»´åº¦] è®¡ç®—å“ªäº›å“ç‰Œçš„ Embedding å‘ç”Ÿäº†å‰§å˜ (è¯´æ˜æ¨¡å‹å­¦åˆ°äº†å…³äºå®ƒçš„æ–°çŸ¥è¯†)
        """
        shifts = []
        # è·å– ID åˆ° åå­— çš„åå‘æ˜ å°„
        id2token = {v: k for k, v in self.vocab.mappers[feature_name].token2id.items()}
        
        # æå– Embedding çŸ©é˜µ
        old_emb = self.old_model.embeddings[feature_name].weight.data.cpu().numpy()
        new_emb = self.new_model.embeddings[feature_name].weight.data.cpu().numpy()
        
        # éå†æ‰€æœ‰å·²çŸ¥ ID (è·³è¿‡ PAD å’Œ UNK)
        for idx in range(2, len(old_emb)):
            if idx in id2token:
                # è®¡ç®—å‘é‡è·ç¦» (L2 Norm)
                diff = np.linalg.norm(old_emb[idx] - new_emb[idx])
                shifts.append((id2token[idx], diff))
        
        # æŒ‰å˜åŒ–å¹…åº¦é™åºæ’åˆ—
        shifts.sort(key=lambda x: x[1], reverse=True)
        return shifts[:top_k]

    def find_repaired_cases(self, val_df, val_loader, top_k_cases=3):
        """
        [å¾®è§‚ç»´åº¦] å¯»æ‰¾ Bad Case ä¿®å¤æ¡ˆä¾‹
        é€»è¾‘ï¼šæ—§æ¨¡å‹æ’å > 5 (å·®)ï¼Œæ–°æ¨¡å‹æ’å <= 3 (å¥½) çš„æ­£æ ·æœ¬
        """
        self.old_model.eval()
        self.new_model.eval()
        
        repaired_cases = []
        
        # è¿™æ˜¯ä¸€ä¸ªç®€åŒ–é€»è¾‘ï¼Œå®é™…éœ€è¦æŒ‰ Session/User åˆ†ç»„è®¡ç®—æ’åº
        # è¿™é‡Œå‡è®¾ dataloader é‡Œçš„æ¯ä¸ª batch æ˜¯ä¸€ç»„å€™é€‰é›†
        # æˆ–è€…æˆ‘ä»¬ç›´æ¥é€æ¡æ‰“åˆ†ï¼Œç„¶åæ‰‹åŠ¨å¯¹æ¯”åˆ†æ•°å·®è·æœ€å¤§çš„æ­£æ ·æœ¬
        
        with torch.no_grad():
            for i, (s, d, t, l) in enumerate(val_loader):
                # å¿…é¡»æ˜¯æ­£æ ·æœ¬ (å®¢æˆ·çœŸå®å»çš„åº—)
                if l.item() == 0: continue
                
                s = {k: v.to(self.config['device']) for k, v in s.items()}
                d, t = d.to(self.config['device']), t.to(self.config['device'])
                
                score_old = self.old_model(s, d, t).item()
                score_new = self.new_model(s, d, t).item()
                
                # å®šä¹‰ "ä¿®å¤": æ–°åˆ†æ•°æ˜¾è‘—é«˜äºæ—§åˆ†æ•°
                if score_new > 0.8 and score_old < 0.4:
                    # è®°å½•è¿™ä¸ªæ¡ˆä¾‹è¯¦æƒ…
                    case_info = {
                        "brand": id2token_brand.get(s['brand_name'].item()),
                        "distance": d[0][0].item() * 50.0, # è¿˜åŸå½’ä¸€åŒ–
                        "old_score": score_old,
                        "new_score": score_new,
                        "improvement": score_new - score_old
                    }
                    repaired_cases.append(case_info)
        
        # æŒ‰æå‡å¹…åº¦æ’åº
        repaired_cases.sort(key=lambda x: x['improvement'], reverse=True)
        return repaired_cases[:top_k_cases]
```

#### æ­¥éª¤ 2: ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š (Markdown/HTML)

å°†ä¸Šè¿°è®¡ç®—ç»“æœæ‹¼æ¥æˆä¸€æ®µäººç±»å¯è¯»çš„æ–‡æœ¬ã€‚

```python
def generate_daily_report(metrics_dict, embedding_shifts, repaired_cases, date_str):
    report = f"""
# ğŸš€ æ¨¡å‹è¿›åŒ–æ—¥æŠ¥ ({date_str})

## 1. æ ¸å¿ƒæŒ‡æ ‡çœ‹æ¿
| æŒ‡æ ‡ | æ—§æ¨¡å‹ | æ–°æ¨¡å‹ | å˜åŒ– |
| :--- | :--- | :--- | :--- |
| **AUC** | {metrics_dict['old_auc']:.4f} | **{metrics_dict['new_auc']:.4f}** | ğŸ”º {(metrics_dict['new_auc']-metrics_dict['old_auc'])*100:.2f}% |
| **LogLoss** | {metrics_dict['old_loss']:.4f} | **{metrics_dict['new_loss']:.4f}** | ğŸ”» {(metrics_dict['new_loss']-metrics_dict['old_loss']):.4f} |

---

## 2. ğŸ§  çŸ¥è¯†å‘ç°ï¼šæ¨¡å‹ä»Šå¤©â€œæ‚Ÿâ€åˆ°äº†ä»€ä¹ˆï¼Ÿ
æ¨¡å‹é‡ç‚¹è°ƒæ•´äº†å¯¹ä»¥ä¸‹**è½¦è¾†å“ç‰Œ**çš„è®¤çŸ¥ï¼ˆEmbedding å‘é‡å‘ç”Ÿå‰§çƒˆä½ç§»ï¼‰ï¼š
"""
    
    for brand, shift in embedding_shifts:
        report += f"- **{brand}** (è®¤çŸ¥è°ƒæ•´å¹…åº¦: {shift:.4f}): å¯èƒ½æºäºä»Šæ—¥è¯¥å“ç‰Œæœ‰æ–°çš„ç»´ä¿®æ¨¡å¼å‡ºç°ã€‚\n"
        
    report += """
---

## 3. âœ¨ äº®ç‚¹æ¡ˆä¾‹ï¼šå®ƒæ¯”æ˜¨å¤©èªæ˜åœ¨å“ªï¼Ÿ
ä»¥ä¸‹æ˜¯**æ—§æ¨¡å‹åˆ¤æ–­å¤±è¯¯**ï¼Œä½†**æ–°æ¨¡å‹ç²¾å‡†å‘½ä¸­**çš„çœŸå®æ¡ˆä¾‹ï¼š

"""
    for i, case in enumerate(repaired_cases):
        report += f"""
### æ¡ˆä¾‹ {i+1}: {case['brand']} ç»´ä¿®åŒ¹é…
- **åœºæ™¯ç‰¹å¾**: è·ç¦» {case['distance']:.1f}km, æ•…éšœæè¿°...
- **æ—§æ¨¡å‹æ‰“åˆ†**: {case['old_score']:.2f} (âŒ è®¤ä¸ºä¸åŒ¹é…)
- **æ–°æ¨¡å‹æ‰“åˆ†**: **{case['new_score']:.2f}** (âœ… å¼ºçƒˆæ¨è)
- **æ¨æµ‹åŸå› **: æ–°æ¨¡å‹é€šè¿‡ BGE è¯­ä¹‰å‘é‡ï¼Œæ›´å‡†ç¡®åœ°è¯†åˆ«äº†è¯¥å“ç‰Œä¸ç½‘ç‚¹èµ„è´¨çš„éšæ€§å…³è”ã€‚
"""

    return report
```

---

### æ–¹æ¡ˆè½åœ°å»ºè®®

ä¸ºäº†è®©é¢†å¯¼æœ€æœ‰ä½“æ„Ÿï¼Œå»ºè®®é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¨é€ï¼š

1.  **é£ä¹¦/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ æœºå™¨äººæ¨é€**ï¼š
    *   æ¯å¤©æ—©ä¸Š 9:00ï¼Œè‡ªåŠ¨å‘é€ä¸Šè¿° Markdown æŠ¥å‘Šåˆ°**æŠ€æœ¯ç®¡ç†ç¾¤**ã€‚
    *   **äº®ç‚¹**ï¼šå¦‚æœ Embedding å˜åŠ¨é‡Œå‡ºç°äº†â€œå°ç±³æ±½è½¦â€ï¼Œé¢†å¯¼ä¸€çœ¼å°±èƒ½çœ‹åˆ°â€œå“¦ï¼Œæˆ‘ä»¬çš„æ¨¡å‹å·²ç»å­¦ä¼šå°ç±³æ±½è½¦äº†â€ï¼Œè¿™ç§æŒæ§æ„Ÿéå¸¸å¼ºã€‚

2.  **å¯è§†åŒ–å¯¹æ¯”å›¾ (Optional)**ï¼š
    *   å¦‚æœæ¡ä»¶å…è®¸ï¼Œç”¨ `matplotlib` ç”»ä¸€å¼  **AUC 7æ—¥è¶‹åŠ¿å›¾**ï¼Œé™„åœ¨æŠ¥å‘Šé‡Œã€‚
    *   ç”»ä¸€å¼  **SHAP åŠ›å¯¼å‘å›¾ (Force Plot)** é’ˆå¯¹é‚£ä¸ªâ€œäº®ç‚¹æ¡ˆä¾‹â€ï¼Œè§£é‡Šä¸ºä»€ä¹ˆåˆ†é«˜äº†ï¼ˆæ¯”å¦‚ï¼šå› ä¸º `text_embedding` çš„è´¡çŒ®å€¼å˜å¤§äº†ï¼‰ã€‚

3.  **å®šæœŸå¤ç›˜ä¼š (Monthly)**ï¼š
    *   æŠŠæ¯å¤©ç§¯ç´¯çš„â€œäº®ç‚¹æ¡ˆä¾‹â€æ”’èµ·æ¥ï¼ŒæŒ‘å‡ºå…¸å‹çš„ 3-5 ä¸ªã€‚
    *   å±•ç¤ºâ€œæ–°å“ç‰Œå†·å¯åŠ¨æ›²çº¿â€ï¼šç”»ä¸€æ¡çº¿ï¼Œæ¨ªè½´æ˜¯æ–°å“ç‰Œä¸Šçº¿å¤©æ•°ï¼Œçºµè½´æ˜¯æ¨¡å‹æ¨èå‡†ç¡®ç‡ã€‚å±•ç¤ºæ›²çº¿æ˜¯å¦‚ä½•éšç€å¤©æ•°å¿«é€Ÿä¸Šå‡çš„ã€‚

### æ€»ç»“

è¿™å¥—æ–¹æ¡ˆçš„æ ¸å¿ƒåœ¨äº**â€œæ˜¾æ€§åŒ–â€**ï¼š
*   **Embedding å˜åŠ¨** = æ˜¾æ€§åŒ–æ¨¡å‹çš„**å­¦ä¹ è¿‡ç¨‹**ã€‚
*   **Bad Case ä¿®å¤** = æ˜¾æ€§åŒ–æ¨¡å‹çš„**ä¸šåŠ¡ä»·å€¼**ã€‚
*   **æ–°å“ç‰Œè¯†åˆ«** = æ˜¾æ€§åŒ–æ¨¡å‹çš„**æ³›åŒ–èƒ½åŠ›**ã€‚

é€šè¿‡è¿™ä¸‰ä¸ªæŠ“æ‰‹ï¼Œä½ ä¸ä»…æ±‡æŠ¥äº†æŠ€æœ¯æŒ‡æ ‡ï¼Œæ›´å±•ç¤ºäº†æ¨¡å‹åƒä¸€ä¸ªâ€œå‘˜å·¥â€ä¸€æ ·åœ¨æ¯å¤©æˆé•¿ã€å­¦ä¹ å’Œä¿®æ­£é”™è¯¯çš„åŠ¨æ€è¿‡ç¨‹ã€‚
